<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
  <title>Devices</title>
</head>
<body>
  <p>
    <ul>
      <li>D1 = GPIO 5</li>
      <li>D2 = GPIO 4</li>
      <li>D3 = GPIO 0</li>
      <li>D4 = GPIO 2</li>
    </ul>
  </p>
  <div id="devices">
  </div>
  <p>
    <ul>
      <li><a href="/nodemcu.jpg">Link documentacion</a></li>
    </ul>
  </p>
  <h6>Trabajo por comida</h6>
</body>
<style>
  h6 {
    text-align: center;
    color: rgb(207, 207, 207);
  }
  button {
    margin-left: 50px;
  }
</style>
<script>
  $(() => {
    $.get('/v1/messages', (items) => {
      
      var controls = [5, 4, 0, 2];
      var speed = 5;

      items.forEach((item) => {
        $('#devices').append([
          '<div id="{0}">'.replace('{0}', item._id),
          '<h3>Name: {0}</h3>'.replace('{0}', item.hostname),
          '<button type="button" onclick="remove(\'{0}\')">Eliminar</button>'
          .replace('{0}', item._id),
          controls.map((control, index) => {
            return [
            '<h3>{0} (GPIO {1})</k3>'
            .replace('{0}', index + 1)
            .replace('{1}', control),
            '<button type="button" onclick="move(\'{0}\', {1}, {2})">abrir</button>'
            .replace('{0}', item.device_id)
            .replace('{1}', speed)
            .replace('{2}', control),
            '<button type="button" onclick="move(\'{0}\', {1}, {2})">cerrar</button>'
            .replace('{0}', item.device_id)
            .replace('{1}', speed * -1)
            .replace('{2}', control),
            ].join('');
          }).join(''),
          '</div>',
        ].join(''));
      });  
    })
    .done(() => {
      console.log('success');
    })
    .fail((e) => {
      console.error(e);
    });
  });

  function move(device_id, speed, gpio) {
    console.log(device_id, speed, gpio);
    $.ajax({
      type: 'POST',
      url: '/v1/messages/{0}/devices'.replace('{0}', device_id),
      data: JSON.stringify({
        speed,
        gpio
      }),
      success: (data) => {
        console.log('success');
      },
      contentType : 'application/json',
    });
  }

  function remove(_id) {
    if (!confirm('Are you sure?')) {
      return;
    }
    $.ajax({
      type: 'DELETE',
      url: '/v1/messages/{0}'.replace('{0}', _id),
      data: JSON.stringify({}),
      success: (data) => {
        console.log('success');
        $('#{0}'.replace('{0}',_id)).empty();
      },
      contentType : 'application/json',
    });
  }

</script>
</html>